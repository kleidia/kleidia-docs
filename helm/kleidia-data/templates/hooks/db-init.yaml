{{- if .Values.postgres.enabled }}
---
# ============================================================================
# Kleidia Complete Database Schema - Single Source of Truth
# ============================================================================
#
# This is the COMPLETE and FINAL schema for Kleidia.
# ALL tables are created here - backend seed.go only ensures they exist.
#
# ESSENTIAL TABLES (15):
#   1. organizations            - Multi-tenant organization isolation
#   2. users                    - User accounts and authentication (with org/role)
#   3. refresh_tokens           - JWT refresh token management
#   4. user_sessions            - Active session tracking
#   5. discovered_agents        - Agents before pairing (unauthenticated)
#   6. agents                   - Paired agents with session binding (authenticated)
#   7. discovered_devices       - YubiKeys discovered by agents
#   8. agent_pairing_sessions   - Agent pairing workflow
#   9. pending_challenges       - Challenge/response authentication (V2 pairing)
#   10. pairing_tokens          - Short-lived pairing tokens
#   11. yubi_keys               - Registered YubiKeys
#   12. yubikey_secrets         - Encrypted secrets (Vault paths)
#   13. certificate_signing_requests - CSR lifecycle tracking
#   14. agent_certificates      - Session-bound agent mTLS certificates (with revocation tracking)
#   15. audit_logs              - Comprehensive audit logging
#   16. compliance_reports      - PDF report generation from audit logs
#
# OPTIONAL TABLES (3 - metadata/audit/caching):
#   14. yubikey_certificates    - YubiKey certificate metadata cache
#   15. certificate_states      - Certificate lifecycle audit trail
#   16. device_config_history   - Device configuration audit trail
#
# TOTAL: 20 tables (hybrid agent discovery + multi-tenant isolation)
#
# REMOVED TABLES (obsolete/unused):
#   ‚ùå operations          - Message queue era (HTTP agents now)
#   ‚ùå workstations        - Removed in v2.0 (machine_id matching instead)
#   ‚ùå user_workstations   - Removed in v2.0
#   ‚ùå certificates        - Not needed (Vault-centric PKI)
#   ‚ùå compliance_reports  - Not implemented
#   ‚ùå security_audit_logs - Duplicate of audit_logs
#
# PERFORMANCE INDEXES (for thousands of agents):
# - Composite indexes on frequently queried combinations
# - DESC ordering for timestamp-based queries
# - Optimized for 10% active agent scenarios

# VERIFICATION:
# kubectl exec postgres-0 -n kleidia -- psql -U yubiuser -d kleidia -c '\dt'
# Expected: 16 tables total
# kubectl exec postgres-0 -n kleidia -- psql -U yubiuser -d kleidia -c '\di'
# Expected: 25+ indexes for optimal performance
# ============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-schema-init
  namespace: {{ .Values.global.namespace }}
  labels:
    app: postgres-init
    component: database
  annotations:
    # Helm hooks for proper deployment ordering
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: postgres-schema-init
    spec:
      restartPolicy: Never
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
      {{- range .Values.global.imagePullSecrets }}
        - name: {{ . }}
      {{- end }}
      {{- else if .Values.global.registry.authSecret }}
      imagePullSecrets:
        - name: {{ .Values.global.registry.authSecret }}
      {{- end }}
      {{- if .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.global.nodeSelector | nindent 8 }}
      {{- end }}
      containers:
      - name: schema-init
        image: {{ include "kleidia-data.image" (dict "repository" "postgres" "tag" "15-alpine" "context" $) }}
        env:
        - name: PGPASSWORD
          value: ""
        command:
        - sh
        - -c
        - |
          set -e
          echo "=== Kleidia Database Schema Initialization ==="
          echo "Waiting for PostgreSQL to be ready..."
          
          # Wait for PostgreSQL to accept connections
          until pg_isready -h postgres.{{ .Values.global.namespace }}.svc.cluster.local -p 5432 -U {{ .Values.postgres.username }} 2>/dev/null; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          echo "PostgreSQL is accepting connections, verifying database exists..."
          
          # Verify database exists and is accessible (with retry logic)
          MAX_ATTEMPTS=30
          ATTEMPT=0
          until psql -h postgres.{{ .Values.global.namespace }}.svc.cluster.local -U {{ .Values.postgres.username }} -d {{ .Values.postgres.database }} -c "SELECT 1" >/dev/null 2>&1; do
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
              echo "‚ùå Failed to connect to {{ .Values.postgres.database }} database after $MAX_ATTEMPTS attempts"
              echo "This may indicate the database was not created during initialization."
              exit 1
            fi
            echo "Database not accessible yet (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            sleep 2
          done
          
          echo "‚úÖ PostgreSQL is ready and database is accessible"
          echo "Initializing/upgrading database schema..."
          
          # Run the complete schema migration (idempotent)
          psql -h postgres.{{ .Values.global.namespace }}.svc.cluster.local \
            -U {{ .Values.postgres.username }} \
            -d {{ .Values.postgres.database }} \
            -v ON_ERROR_STOP=1 <<'EOSQL'
          
          -- ========================================================================
          -- Kleidia Complete Database Schema v2.2 (Challenge/Response Authentication)
          -- Last updated: January 21, 2025
          -- Total tables: 17 (14 essential + 3 audit/metadata)
          -- ========================================================================
          
          BEGIN;
          
          -- ========================================================================
          -- AUTHENTICATION & AUTHORIZATION (3 tables) + BOOTSTRAP LOCKS
          -- ========================================================================
          
          -- ========================================================================
          -- MULTI-TENANT ORGANIZATIONS
          -- ========================================================================
          
          -- Organizations table (multi-tenant isolation)
          CREATE TABLE IF NOT EXISTS organizations (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255) UNIQUE NOT NULL,
              oidc_claim_value VARCHAR(255) UNIQUE,
              is_active BOOLEAN DEFAULT true,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_organizations_deleted_at ON organizations(deleted_at);
          CREATE INDEX IF NOT EXISTS idx_organizations_oidc_claim_value ON organizations(oidc_claim_value);
          CREATE INDEX IF NOT EXISTS idx_organizations_is_active ON organizations(is_active);
          
          -- Users table
          CREATE TABLE IF NOT EXISTS users (
              id SERIAL PRIMARY KEY,
              email VARCHAR(255) UNIQUE NOT NULL,
              username VARCHAR(255) UNIQUE NOT NULL,
              full_name VARCHAR(255),
              hashed_password TEXT NOT NULL,
              is_admin BOOLEAN DEFAULT FALSE,
              is_active BOOLEAN DEFAULT TRUE,
              organization_id INTEGER REFERENCES organizations(id) ON DELETE SET NULL,
              role VARCHAR(50) DEFAULT 'user',
              oidc_organization_claim VARCHAR(255),
              oidc_role_claim VARCHAR(255),
              role_override BOOLEAN DEFAULT false,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
          CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
          CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);
          CREATE INDEX IF NOT EXISTS idx_users_organization_id ON users(organization_id);
          CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
          
          -- Migration: Add multi-tenant columns to existing users table (v2.3+)
          ALTER TABLE users ADD COLUMN IF NOT EXISTS organization_id INTEGER REFERENCES organizations(id) ON DELETE SET NULL;
          ALTER TABLE users ADD COLUMN IF NOT EXISTS role VARCHAR(50) DEFAULT 'user';
          ALTER TABLE users ADD COLUMN IF NOT EXISTS oidc_organization_claim VARCHAR(255);
          ALTER TABLE users ADD COLUMN IF NOT EXISTS oidc_role_claim VARCHAR(255);
          ALTER TABLE users ADD COLUMN IF NOT EXISTS role_override BOOLEAN DEFAULT false;
          
          -- Migrate existing admin users to global_admin role
          UPDATE users SET role = 'global_admin' WHERE is_admin = true AND role = 'user';
          -- Also migrate any existing super_admin roles to global_admin
          UPDATE users SET role = 'global_admin' WHERE role = 'super_admin';
          
          -- Refresh tokens for JWT management
          CREATE TABLE IF NOT EXISTS refresh_tokens (
              id SERIAL PRIMARY KEY,
              token VARCHAR(255) UNIQUE NOT NULL,
              token_hash VARCHAR(255),
              user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
              device_id VARCHAR(255),
              ip_address VARCHAR(45),
              user_agent TEXT,
              expires_at TIMESTAMP NOT NULL,
              last_used_at TIMESTAMP,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ON refresh_tokens(user_id);
          CREATE INDEX IF NOT EXISTS idx_refresh_tokens_token ON refresh_tokens(token);
          CREATE INDEX IF NOT EXISTS idx_refresh_tokens_token_hash ON refresh_tokens(token_hash);
          CREATE INDEX IF NOT EXISTS idx_refresh_tokens_device_id ON refresh_tokens(device_id);
          CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at ON refresh_tokens(expires_at);
          
          -- Migration: Add new columns to existing refresh_tokens table (v2.2+)
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS token_hash VARCHAR(255);
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS device_id VARCHAR(255);
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS ip_address VARCHAR(45);
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS user_agent TEXT;
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS last_used_at TIMESTAMP;
          ALTER TABLE refresh_tokens ADD COLUMN IF NOT EXISTS is_revoked BOOLEAN DEFAULT FALSE;
          
          -- User sessions with agent public key for encryption
          CREATE TABLE IF NOT EXISTS user_sessions (
              id SERIAL PRIMARY KEY,
              user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              session_token VARCHAR(255) UNIQUE NOT NULL,
              ip_address VARCHAR(45),
              user_agent TEXT,
              last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              expires_at TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              is_active BOOLEAN DEFAULT TRUE,
              agent_pubkey TEXT -- Ephemeral agent public key for encryption
          );
          
          CREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);
          CREATE INDEX IF NOT EXISTS idx_user_sessions_session_token ON user_sessions(session_token);
          CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);
          -- Performance indexes for thousands of agents
          CREATE INDEX IF NOT EXISTS idx_user_sessions_user_active ON user_sessions(user_id, is_active);
          
          -- Migration: Add updated_at column to user_sessions table (v2.2+)
          ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

          -- ------------------------------------------------------------------------
          -- Bootstrap locks (first-visit admin creation) - short-lived, race-safety
          -- ------------------------------------------------------------------------
          CREATE TABLE IF NOT EXISTS bootstrap_locks (
              id SERIAL PRIMARY KEY,
              ip_hash VARCHAR(128) NOT NULL,
              user_agent_hash VARCHAR(128),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              expires_at TIMESTAMP NOT NULL
          );

          CREATE INDEX IF NOT EXISTS idx_bootstrap_locks_expires_at ON bootstrap_locks(expires_at);
          
          -- ========================================================================
          -- AGENT MANAGEMENT (4 tables)
          -- ========================================================================
          
          -- HTTP agents (simplified - no registration needed)
          CREATE TABLE IF NOT EXISTS agents (
              id SERIAL PRIMARY KEY,
              owner_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_agents_owner_id ON agents(owner_id);
          
          -- Discovered devices from agents
          CREATE TABLE IF NOT EXISTS discovered_devices (
              id SERIAL PRIMARY KEY,
              serial VARCHAR(255) NOT NULL,
              model VARCHAR(255),
              device_type VARCHAR(255),
              firmware VARCHAR(255),
              usb_interfaces TEXT,
              applications TEXT,
              firmware_detailed VARCHAR(255),
              last_seen TIMESTAMP,
              is_registered BOOLEAN DEFAULT FALSE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_discovered_devices_serial ON discovered_devices(serial);
          CREATE INDEX IF NOT EXISTS idx_discovered_devices_is_registered ON discovered_devices(is_registered);
          
          -- Discovered agents (unauthenticated - hybrid approach)
          -- NOTE: Deprecated - agents are now session-scoped, no persistent identity
          -- This table is kept for backward compatibility but not used
          CREATE TABLE IF NOT EXISTS discovered_agents (
              id SERIAL PRIMARY KEY,
              agent_version VARCHAR(50),
              platform VARCHAR(50),
              address VARCHAR(255),
              public_key TEXT,
              public_key_algo VARCHAR(50),
              first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              health_status VARCHAR(20) DEFAULT 'unknown',
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_discovered_agents_last_seen ON discovered_agents(last_seen);
          CREATE INDEX IF NOT EXISTS idx_discovered_agents_health_status ON discovered_agents(health_status);
          
          -- Agent pairing sessions
          CREATE TABLE IF NOT EXISTS agent_pairing_sessions (
              id SERIAL PRIMARY KEY,
              token VARCHAR(255) UNIQUE NOT NULL,
              user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              workstation VARCHAR(255) NOT NULL,
              status VARCHAR(50) DEFAULT 'pending',
              expires_at TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              completed_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_agent_pairing_sessions_token ON agent_pairing_sessions(token);
          CREATE INDEX IF NOT EXISTS idx_agent_pairing_sessions_user_id ON agent_pairing_sessions(user_id);
          CREATE INDEX IF NOT EXISTS idx_agent_pairing_sessions_status ON agent_pairing_sessions(status);
          
          -- Pending challenges for challenge/response authentication (V2 pairing)
          CREATE TABLE IF NOT EXISTS pending_challenges (
              id SERIAL PRIMARY KEY,
              nonce VARCHAR(255) UNIQUE NOT NULL,
              user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              session_id INTEGER REFERENCES user_sessions(id) ON DELETE SET NULL,
              user_uid VARCHAR(255),
              status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'verified', 'expired')),
              expires_at TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_pending_challenges_nonce ON pending_challenges(nonce);
          CREATE INDEX IF NOT EXISTS idx_pending_challenges_status_expires ON pending_challenges(status, expires_at);
          CREATE INDEX IF NOT EXISTS idx_pending_challenges_user_id ON pending_challenges(user_id);
          CREATE INDEX IF NOT EXISTS idx_pending_challenges_session_id ON pending_challenges(session_id);
          
          -- Short-lived pairing tokens
          CREATE TABLE IF NOT EXISTS pairing_tokens (
              id SERIAL PRIMARY KEY,
              token VARCHAR(255) UNIQUE NOT NULL,
              user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
              session_id INTEGER REFERENCES user_sessions(id) ON DELETE CASCADE,
              expires_at TIMESTAMP NOT NULL,
              used BOOLEAN DEFAULT FALSE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_pairing_tokens_token ON pairing_tokens(token);
          CREATE INDEX IF NOT EXISTS idx_pairing_tokens_user_id ON pairing_tokens(user_id);
          CREATE INDEX IF NOT EXISTS idx_pairing_tokens_expires_at ON pairing_tokens(expires_at);
          
          -- ========================================================================
          -- YUBIKEY MANAGEMENT (3 tables)
          -- ========================================================================
          
          -- Registered YubiKeys
          CREATE TABLE IF NOT EXISTS yubi_keys (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255),
              description TEXT,
              serial VARCHAR(255) UNIQUE NOT NULL,
              model VARCHAR(255),
              firmware VARCHAR(255),
              interfaces VARCHAR(255),
              device_type VARCHAR(50) NOT NULL,
              device_id VARCHAR(255),
              owner_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              label VARCHAR(255),
              is_active BOOLEAN DEFAULT TRUE,
              last_seen TIMESTAMP,
              pin_is_default BOOLEAN DEFAULT NULL,
              puk_is_default BOOLEAN DEFAULT NULL,
              mgmt_key_is_default BOOLEAN DEFAULT NULL,
              defaults_checked_at TIMESTAMP,
              pin_retry_count INTEGER DEFAULT NULL,
              puk_retry_count INTEGER DEFAULT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          -- Add interfaces column if not exists (for upgrades from older versions)
          ALTER TABLE yubi_keys ADD COLUMN IF NOT EXISTS interfaces VARCHAR(255);
          
          CREATE INDEX IF NOT EXISTS idx_yubi_keys_serial ON yubi_keys(serial);
          CREATE INDEX IF NOT EXISTS idx_yubi_keys_owner_id ON yubi_keys(owner_id);
          CREATE INDEX IF NOT EXISTS idx_yubi_keys_is_active ON yubi_keys(is_active);
          
          -- YubiKey secrets (stores Vault paths to encrypted secrets)
          CREATE TABLE IF NOT EXISTS yubikey_secrets (
              id SERIAL PRIMARY KEY,
              yubikey_id INTEGER REFERENCES yubi_keys(id) ON DELETE CASCADE,
              vault_path VARCHAR(500) NOT NULL,
              secret_type VARCHAR(50) NOT NULL,
              is_default BOOLEAN DEFAULT NULL,
              created_by INTEGER REFERENCES users(id),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_yubikey_secrets_yubikey_id ON yubikey_secrets(yubikey_id);
          CREATE INDEX IF NOT EXISTS idx_yubikey_secrets_secret_type ON yubikey_secrets(secret_type);
          
          -- YubiKey certificate metadata cache (optional - for performance)
          CREATE TABLE IF NOT EXISTS yubikey_certificates (
              id SERIAL PRIMARY KEY,
              yubikey_id INTEGER REFERENCES yubi_keys(id) ON DELETE CASCADE,
              slot VARCHAR(10) NOT NULL,
              subject TEXT,
              issuer TEXT,
              serial_number VARCHAR(255),
              not_before TIMESTAMP,
              not_after TIMESTAMP,
              is_self_signed BOOLEAN DEFAULT FALSE,
              certificate_pem TEXT NOT NULL,
              status VARCHAR(20) DEFAULT 'active',
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_yubikey_certificates_yubikey_id ON yubikey_certificates(yubikey_id);
          CREATE INDEX IF NOT EXISTS idx_yubikey_certificates_slot ON yubikey_certificates(slot);
          CREATE INDEX IF NOT EXISTS idx_yubikey_certificates_status ON yubikey_certificates(status);
          
          -- ========================================================================
          -- PKI & CERTIFICATE MANAGEMENT (2 tables)
          -- ========================================================================
          
          -- Certificate signing requests
          CREATE TABLE IF NOT EXISTS certificate_signing_requests (
              id SERIAL PRIMARY KEY,
              yubikey_id INTEGER REFERENCES yubi_keys(id) ON DELETE CASCADE,
              slot VARCHAR(10) NOT NULL,
              csr_pem TEXT NOT NULL,
              status VARCHAR(20) DEFAULT 'pending',
              vault_request_id VARCHAR(255),
              error_message TEXT,
              correlation_id VARCHAR(255),
              created_by INTEGER REFERENCES users(id) NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              completed_at TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_certificate_signing_requests_yubikey_id ON certificate_signing_requests(yubikey_id);
          CREATE INDEX IF NOT EXISTS idx_certificate_signing_requests_status ON certificate_signing_requests(status);
          CREATE INDEX IF NOT EXISTS idx_certificate_signing_requests_created_by ON certificate_signing_requests(created_by);
          
          -- Certificate states for lifecycle tracking (audit trail)
          CREATE TABLE IF NOT EXISTS certificate_states (
              id SERIAL PRIMARY KEY,
              yubikey_id INTEGER REFERENCES yubi_keys(id) ON DELETE CASCADE,
              slot VARCHAR(10) NOT NULL,
              state VARCHAR(20) NOT NULL,
              details JSONB,
              created_by INTEGER REFERENCES users(id),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_certificate_states_yubikey_id ON certificate_states(yubikey_id);
          CREATE INDEX IF NOT EXISTS idx_certificate_states_slot ON certificate_states(slot);
          CREATE INDEX IF NOT EXISTS idx_certificate_states_state ON certificate_states(state);
          
          -- Agent certificates (session-bound mTLS certificates)
          CREATE TABLE IF NOT EXISTS agent_certificates (
              id SERIAL PRIMARY KEY,
              agent_id INTEGER NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
              user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              session_id INTEGER NOT NULL REFERENCES user_sessions(id) ON DELETE CASCADE,
              serial_number VARCHAR(255) UNIQUE NOT NULL,
              issued_at TIMESTAMP NOT NULL,
              expires_at TIMESTAMP NOT NULL,
              revoked_at TIMESTAMP,
              revocation_reason VARCHAR(255) DEFAULT '',
              issued_by VARCHAR(255),
              common_name VARCHAR(255),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_agent_id ON agent_certificates(agent_id);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_user_id ON agent_certificates(user_id);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_session_id ON agent_certificates(session_id);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_serial_number ON agent_certificates(serial_number);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_expires_at ON agent_certificates(expires_at);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_revoked_at ON agent_certificates(revoked_at);
          CREATE INDEX IF NOT EXISTS idx_agent_certificates_revocation_reason ON agent_certificates(revocation_reason);
          
          -- ========================================================================
          -- AUDIT & COMPLIANCE (2 tables)
          -- ========================================================================
          
          -- Comprehensive audit logging (NOTE: plural "audit_logs", not "audit_log"!)
          CREATE TABLE IF NOT EXISTS audit_logs (
              id SERIAL PRIMARY KEY,
              user_id INTEGER REFERENCES users(id),
              action VARCHAR(255) NOT NULL,
              resource VARCHAR(255) NOT NULL,
              resource_id VARCHAR(255),
              details TEXT,
              ip_address VARCHAR(45),
              hostname VARCHAR(255),
              user_agent TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs(user_id);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs(action);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_resource ON audit_logs(resource);
          -- Performance indexes for thousands of agents (critical for compliance)
          CREATE INDEX IF NOT EXISTS idx_audit_logs_user_created_at ON audit_logs(user_id, created_at DESC);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_action_created_at ON audit_logs(action, created_at DESC);
          
          -- Compliance reports for PDF generation from audit logs
          CREATE TABLE IF NOT EXISTS compliance_reports (
              id SERIAL PRIMARY KEY,
              report_type VARCHAR(50) NOT NULL,
              report_data JSONB NOT NULL,
              generated_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
              date_range_start TIMESTAMP NOT NULL,
              date_range_end TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_compliance_reports_report_type ON compliance_reports(report_type);
          CREATE INDEX IF NOT EXISTS idx_compliance_reports_generated_by ON compliance_reports(generated_by);
          CREATE INDEX IF NOT EXISTS idx_compliance_reports_created_at ON compliance_reports(created_at);
          CREATE INDEX IF NOT EXISTS idx_compliance_reports_date_range ON compliance_reports(date_range_start, date_range_end);
          
          -- ========================================================================
          -- SYSTEM SETTINGS & POLICIES (2 tables)
          -- ========================================================================
          
          -- System settings (key-value store for admin configuration)
          CREATE TABLE IF NOT EXISTS system_settings (
              key VARCHAR(255) PRIMARY KEY,
              value JSONB NOT NULL,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_by INTEGER REFERENCES users(id) ON DELETE SET NULL
          );
          
          CREATE INDEX IF NOT EXISTS idx_system_settings_updated_at ON system_settings(updated_at);
          
          -- Security policies (aligns with models.Policy)
          CREATE TABLE IF NOT EXISTS policies (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255) UNIQUE NOT NULL,
              description TEXT,
              rules JSONB NOT NULL,
              is_active BOOLEAN DEFAULT TRUE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              deleted_at TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_policies_name ON policies(name);
          CREATE INDEX IF NOT EXISTS idx_policies_is_active ON policies(is_active);
          CREATE INDEX IF NOT EXISTS idx_policies_deleted_at ON policies(deleted_at);
          
          -- Insert default policy if none exists
          INSERT INTO policies (name, description, rules, is_active)
          SELECT 'default', 'Default security policy', 
                 '{"password":{"min_length":8,"require_uppercase":false,"require_lowercase":false,"require_numbers":false,"require_special":false},"pin":{"min_length":6,"max_length":8,"require_digits_only":true},"puk":{"min_length":6,"max_length":8,"require_digits_only":true},"certificate":{"allowed_algorithms":["RSA2048","ECCP384"],"max_ttl_hours":8760}}'::jsonb,
                 TRUE
          WHERE NOT EXISTS (SELECT 1 FROM policies WHERE name = 'default' AND deleted_at IS NULL);
          
          -- ========================================================================
          -- CERTIFICATE TRACKING & NOTIFICATIONS (2 tables)
          -- ========================================================================
          
          -- Issued certificates (tracks certificates with expiry dates for notifications)
          -- Certificate metadata for expiry tracking (certificates stored in Vault)
          CREATE TABLE IF NOT EXISTS issued_certificates (
              id SERIAL PRIMARY KEY,
              owner_user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
              yubikey_id INTEGER REFERENCES yubi_keys(id) ON DELETE SET NULL,
              csr_id INTEGER REFERENCES certificate_signing_requests(id) ON DELETE SET NULL,
              subject TEXT NOT NULL,
              vault_path TEXT NOT NULL,        -- Path to certificate in Vault KV (e.g., {serial}/certificates/9a)
              serial_number TEXT,              -- X.509 certificate serial number
              not_before TIMESTAMP NOT NULL,
              not_after TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_owner_user_id ON issued_certificates(owner_user_id);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_yubikey_id ON issued_certificates(yubikey_id);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_csr_id ON issued_certificates(csr_id);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_not_after ON issued_certificates(not_after);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_created_at ON issued_certificates(created_at);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_vault_path ON issued_certificates(vault_path);
          CREATE INDEX IF NOT EXISTS idx_issued_certificates_serial_number ON issued_certificates(serial_number);
          
          -- Certificate notification log (tracks which notifications have been sent)
          CREATE TABLE IF NOT EXISTS certificate_notification_log (
              id SERIAL PRIMARY KEY,
              certificate_id INTEGER NOT NULL REFERENCES issued_certificates(id) ON DELETE CASCADE,
              window_days INTEGER NOT NULL,
              sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              UNIQUE(certificate_id, window_days)
          );
          
          CREATE INDEX IF NOT EXISTS idx_certificate_notification_log_certificate_id ON certificate_notification_log(certificate_id);
          CREATE INDEX IF NOT EXISTS idx_certificate_notification_log_sent_at ON certificate_notification_log(sent_at);
          CREATE INDEX IF NOT EXISTS idx_certificate_notification_log_window_days ON certificate_notification_log(window_days);
          
          -- ========================================================================
          -- ADD agent_pubkey COLUMN (v2.2 simplified agent architecture)
          -- ========================================================================
          
          ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS agent_pubkey TEXT;
          
          -- ========================================================================
          -- LICENSE MANAGEMENT (2 tables)
          -- ========================================================================
          
          -- System license (stores license information and history)
          CREATE TABLE IF NOT EXISTS system_license (
              id SERIAL PRIMARY KEY,
              license_data TEXT NOT NULL,
              signature TEXT NOT NULL,
              installation_id VARCHAR(255) NOT NULL,
              customer_name VARCHAR(255),
              customer_email VARCHAR(255),
              issue_date TIMESTAMP NOT NULL,
              expiry_date TIMESTAMP NOT NULL,
              license_type VARCHAR(50) NOT NULL,
              is_active BOOLEAN DEFAULT true,
              uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              uploaded_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
              last_validated_at TIMESTAMP,
              validation_errors TEXT
          );
          
          CREATE INDEX IF NOT EXISTS idx_system_license_installation_id ON system_license(installation_id);
          CREATE INDEX IF NOT EXISTS idx_system_license_is_active ON system_license(is_active);
          CREATE INDEX IF NOT EXISTS idx_system_license_expiry_date ON system_license(expiry_date);
          CREATE INDEX IF NOT EXISTS idx_system_license_uploaded_at ON system_license(uploaded_at DESC);
          
          -- License validation log (tracks license validation attempts)
          CREATE TABLE IF NOT EXISTS license_validation_log (
              id SERIAL PRIMARY KEY,
              license_id INTEGER REFERENCES system_license(id) ON DELETE SET NULL,
              validated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              validation_result VARCHAR(50) NOT NULL,
              error_message TEXT,
              system_time TIMESTAMP NOT NULL,
              time_source VARCHAR(50)
          );
          
          CREATE INDEX IF NOT EXISTS idx_license_validation_log_license_id ON license_validation_log(license_id);
          CREATE INDEX IF NOT EXISTS idx_license_validation_log_validated_at ON license_validation_log(validated_at DESC);
          CREATE INDEX IF NOT EXISTS idx_license_validation_log_validation_result ON license_validation_log(validation_result);
          
          -- ========================================================================
          -- CLEANUP: Remove obsolete tables from previous versions
          -- ========================================================================
          
          -- Remove message queue-era operations table (HTTP agents now)
          DROP TABLE IF EXISTS operations CASCADE;
          
          -- Remove v1.0 workstation approval tables (machine_id matching in v2.0)
          DROP TABLE IF EXISTS user_workstations CASCADE;
          DROP TABLE IF EXISTS workstations CASCADE;
          
          -- Remove general certificates table (Vault-centric PKI now)
          DROP TABLE IF EXISTS certificates CASCADE;
          
          -- Remove duplicate security_audit_logs table (use audit_logs instead)
          DROP TABLE IF EXISTS security_audit_logs CASCADE;
          
          COMMIT;
          
          -- ========================================================================
          -- BACKUP JOBS (1 table)
          -- ========================================================================
          
          -- Backup jobs (tracks backup and restore job history)
          CREATE TABLE IF NOT EXISTS backup_jobs (
              id SERIAL PRIMARY KEY,
              job_name VARCHAR(255) NOT NULL,
              job_type VARCHAR(50) NOT NULL,
              backup_type VARCHAR(50),
              status VARCHAR(50) NOT NULL DEFAULT 'pending',
              started_at TIMESTAMP,
              completed_at TIMESTAMP,
              file_key VARCHAR(500),
              file_size BIGINT,
              error_message TEXT,
              triggered_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
              k8s_job_name VARCHAR(255),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_backup_jobs_status ON backup_jobs(status);
          CREATE INDEX IF NOT EXISTS idx_backup_jobs_job_type ON backup_jobs(job_type);
          CREATE INDEX IF NOT EXISTS idx_backup_jobs_created_at ON backup_jobs(created_at DESC);
          CREATE INDEX IF NOT EXISTS idx_backup_jobs_k8s_job_name ON backup_jobs(k8s_job_name);
          
          -- ========================================================================
          -- Schema initialization complete
          -- ========================================================================
          
          EOSQL
          
          echo ""
          echo "‚úÖ Kleidia database schema initialized successfully!"
          echo ""
          echo "üìä Schema Summary (Multi-Tenant + Certificate Revocation + License Management + Backup):"
          echo "  Essential tables (19): organizations, users, refresh_tokens, user_sessions,"
          echo "                          discovered_agents, agents, discovered_devices,"
          echo "                          agent_pairing_sessions, pending_challenges,"
          echo "                          pairing_tokens, yubi_keys, yubikey_secrets,"
          echo "                          certificate_signing_requests, agent_certificates,"
          echo "                          audit_logs, compliance_reports, system_license,"
          echo "                          license_validation_log, backup_jobs"
          echo ""
          echo "  Optional tables (3):   yubikey_certificates, certificate_states,"
          echo "                          device_config_history"
          echo ""
          echo "  Total: 21 tables"
          echo ""
          echo "üîÑ Hybrid Agent Discovery:"
          echo "  1. Agents auto-register in discovered_agents (unauthenticated)"
          echo "  2. Users pair agents ‚Üí moved to agents table (authenticated)"
          echo "  3. Stale discovered_agents cleaned up after 24h"
          echo ""
          echo "üóëÔ∏è  Removed obsolete tables:"
          echo "  ‚ùå operations (message queue era)"
          echo "  ‚ùå workstations, user_workstations (v1.0 workstation approval)"
          echo "  ‚ùå certificates (Vault-centric PKI now)"
          echo "  ‚ùå compliance_reports (not implemented)"
          echo "  ‚ùå security_audit_logs (duplicate)"
          echo ""
          
{{- end }}
