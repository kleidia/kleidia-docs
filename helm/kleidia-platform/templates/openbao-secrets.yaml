{{- if .Values.openbao.enabled }}
---
# OpenBao Unseal Key Secret (static seal)
# This secret holds the static unseal key for OpenBao.
# 
# Auto-unseal mode: Key is populated, OpenBao reads it on startup and auto-unseals
# Manual unseal mode: Key is empty/cleared, admin must provide via UI after pod restart
#
# The key is generated at Helm install time using a random 32-byte base64-encoded value.
# Admin can toggle between auto-unseal and manual unseal via the Kleidia UI.
#
# This is a regular resource (not a hook) to ensure it's created with the namespace.
# Helm creates resources in a deterministic order, and Secrets come before StatefulSets.
apiVersion: v1
kind: Secret
metadata:
  name: openbao-unseal-key
  namespace: {{ .Values.global.namespace }}
  labels:
    app: openbao
    component: unseal-key
  annotations:
    # Keep this secret on helm uninstall (preserves unseal key for upgrades)
    helm.sh/resource-policy: keep
type: Opaque
stringData:
  # Generate a random 32-byte key (base64 encoded) at install time
  # This key is used by OpenBao's static seal mechanism
  unseal-kleidia-1.key: {{ randAlphaNum 32 | b64enc | quote }}
{{- end }}

