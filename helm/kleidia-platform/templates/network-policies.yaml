apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-kleidia-internal
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector: {}  # Apply to all pods in the namespace
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow all traffic from pods in the same namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Values.global.namespace }}
  # Allow traffic from kube-system (for DNS, metrics, etc.)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
  egress:
  # Allow all traffic to pods in the same namespace
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Values.global.namespace }}
  # Allow DNS queries to kube-system
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS/HTTP egress (for external services, registries, etc.)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
  # Allow all egress to cluster IPs (for service discovery)
  - to:
    - namespaceSelector: {}
---
# Allow OpenBao unrestricted egress to reach Kubernetes API server for TokenReview
# CRITICAL: OpenBao needs to call K8s API to validate service account tokens
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openbao-api-server-access
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: openbao
  policyTypes:
  - Egress
  egress:
  # Allow all egress - OpenBao needs unrestricted access to validate tokens
  - {}
---
# Allow OpenBao setup/init jobs to access Kubernetes API server
# This job needs broad network access for initialization tasks
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openbao-init-api-access
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - openbao-init
  policyTypes:
  - Egress
  egress:
  # Allow all egress - this job needs to access K8s API, OpenBao, and DNS
  - {}
---
# Specific policy for backend to access OpenBao, Postgres, and Kubernetes API
# CRITICAL: Backend needs unrestricted egress to:
#  - Call Kubernetes API to manage secrets (read/delete)
#  - Connect to external OIDC providers
#  - Access internal services (OpenBao, Postgres, License Service)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-access-policy
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Egress
  egress:
  # Allow all egress - backend needs unrestricted access
  - {}
---
# Allow external traffic to frontend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-ingress-policy
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  ingress:
  # Allow traffic from anywhere (NodePort/LoadBalancer)
  - {}
---
# Allow backend API access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-ingress-policy
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  # Allow traffic from frontend
  - from:
    - podSelector:
        matchLabels:
          app: frontend
  # Allow traffic from anywhere (NodePort/LoadBalancer for direct API access)
  - {}
---
# Restrict OpenBao access to authorized services only
# SECURITY: Only backend, license-service, and cert-manager can access OpenBao
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openbao-ingress-restrict
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: openbao
  policyTypes:
  - Ingress
  ingress:
  # Allow from backend
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 8200
  # Allow from license-service
  - from:
    - podSelector:
        matchLabels:
          app: license-service
    ports:
    - protocol: TCP
      port: 8200
  # Allow from init jobs
  - from:
    - podSelector:
        matchLabels:
          app: openbao-init
    ports:
    - protocol: TCP
      port: 8200
  # Allow from cert-manager (for PKI operations)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: cert-manager
    ports:
    - protocol: TCP
      port: 8200
  # Allow internal cluster traffic (for health checks, cluster sync)
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: openbao
    ports:
    - protocol: TCP
      port: 8200
    - protocol: TCP
      port: 8201

